# 要件定義書：ガチャ自販機サイト

## 1. 概要

### 1.1. プロジェクトの背景
大学のキャンパス内に設置された、特定の自動販売機に存在する「二人専用ランダムドリンクボタン」機能（以下、ガチャ）を対象とする。このガチャは、自販機内で最も安い飲料の2倍の価格で、ランダムなドリンクが2本排出される仕様となっており、利用者が金銭的に損をすることはない。

### 1.2. プロジェクトの目的
このガチャ体験をより楽しく、コミュニティで共有できるものにするため、結果の投稿・集計を行うWebサイトを開発する。利用者はガチャの結果を記録し、他の利用者の結果を閲覧し、統計情報を楽しむことができる。これにより、ガチャ体験に新たな価値を付与し、利用者間のコミュニケーションを誘発する。

---

## 2. 機能要件

### 2.1. 機能一覧
- **F-01**: ガチャ結果投稿機能
- **F-02**: 投稿タイムライン表示機能
- **F-03**: 統計情報表示機能
- **F-04**: 個人累計お得額表示機能

### 2.2. 機能詳細
- **F-01: ガチャ結果投稿機能**
    - ユーザーは、ガチャで排出されたドリンク2本の名前を入力する。
    - 任意で、結果の写真をアップロードできる。
    - 投稿日時はシステムが自動的に記録する。

- **F-02: 投稿タイムライン表示機能**
    - すべてのユーザーの投稿を時系列（新しい順）で表示する。
    - 各投稿には、そのガチャで得した金額（お得度）を表示する。（例：「+30円お得！」）

- **F-03: 統計情報表示機能**
    - 以下の統計情報を表示する。
        1.  **ドリンク別排出率ランキング**: これまで排出された全ドリンクの品目別ランキング。
        2.  **お得度ランキング**: 最も得した金額が大きかった投稿の組み合わせランキング。
        3.  **サイト全体の累計お得額**: 全ユーザーの総利益額。

- **F-04: 個人累計お得額表示機能**
    - サイト訪問者個人の、これまでの累計お得額を表示する。
    - この記録は、ユーザー登録を不要とし、ブラウザのローカルストレージ等に保存する。

---

## 3. データ要件

### 3.1. 主要データモデル
- **投稿 (Post)**
    - `ID`: 一意の識別子
    - `drink_1_name`: ドリンク1の名前 (string)
    - `drink_2_name`: ドリンク2の名前 (string)
    - `photo_url`: 写真のURL (string, nullable)
    - `created_at`: 投稿日時 (timestamp)
    - `profit`: お得度（円） (integer)
- **ドリンクマスター (DrinkMaster)**
    - `ID`: 一意の識別子
    - `name`: ドリンク名 (string)
    - `price`: 通常価格（円） (integer)

### 3.2. データフロー
1.  **投稿時**:
    1.  ユーザーが投稿フォームにドリンク名2つを入力し、送信する。
    2.  サーバーは受信したドリンク名2つを元に、`ドリンクマスター`からそれぞれの価格を取得する。
    3.  `（価格1 + 価格2） - ガチャ価格` の計算式で `profit` を算出する。
    4.  `投稿`データとして、各種情報と共にデータベースに保存する。
2.  **表示時**:
    1.  クライアント（ブラウザ）がサーバーに`投稿`データを要求する。
    2.  サーバーはデータベースから`投稿`データを取得し、クライアントに送信する。
    3.  クライアントは受信したデータを元に、タイムラインや各種統計を描画する。

---

## 4. 画面要件

### 4.1. 画面一覧
- **A-01**: メイン画面 (SPA)
- **A-02**: 投稿フォーム (モーダル/オーバーレイ)

### 4.2. 画面構成・遷移
本サイトは単一のページ（シングルページアプリケーション）で構成される。

- **全体構成**:
    - `ヘッダー`: サイトタイトルを常時表示。
    - `メインコンテンツ`: タブ切り替えで表示内容が変化する。
    - `投稿ボタン`: フローティングアクションボタン（FAB）として画面右下などに常時表示。
- **画面遷移**:
    1.  サイトにアクセスすると、**A-01: メイン画面**が表示される。デフォルトのタブは「タイムライン」。
    2.  メイン画面上部の `[タイムライン]` `[統計]` タブをタップすることで、ページ遷移なくコンテンツの表示が切り替わる。
    3.  `投稿ボタン`をタップすると、**A-02: 投稿フォーム**がモーダルウィンドウ（または画面下からのスライドアップ）として表示される。
    4.  投稿フォームで「投稿」または「キャンセル」をタップすると、フォームが閉じてメイン画面に戻る。

---

## 5. 非機能要件

### 5.1. ユーザビリティ (UI/UX)
- **デザイン**: ミニマリスト的で、不要な装飾を排したシンプルなデザインとする。
- **操作性**: ITリテラシーに依らず、誰でも直感的に操作・投稿ができること。
- **プラットフォーム**: スマートフォンでの閲覧・操作に最適化されたモバイルファースト設計とする。

### 5.2. パフォーマンス
- ページ読み込み、タブ切り替え、統計計算などの各種操作に対し、ユーザーがストレスを感じない高速なレスポンスを維持すること。

---

## 6. 技術スタック

### 6.1. フロントエンド
- **フレームワーク**: Next.js (App Router)
- **言語**: TypeScript
- **スタイリング**: Tailwind CSS
- **UIコンポーネント**: Radix UI

### 6.2. バックエンド
- **データベース**: Firebase Firestore
- **ストレージ**: Firebase Storage（画像保存用）
- **関数**: Firebase Cloud Functions
- **認証**: 不要（匿名利用）

---

## 7. データベース設計

### 7.1. Firestoreコレクション構造

#### postsコレクション
```
posts/{postId}
  - drink1Name: string       // ドリンク1の名前
  - drink2Name: string       // ドリンク2の名前
  - photoUrl: string | null  // 写真のURL
  - profit: number          // お得度（円）
  - createdAt: Timestamp    // 投稿日時
```

#### drinkMasterコレクション
```
drinkMaster/{drinkId}
  - name: string    // ドリンク名
  - price: number   // 通常価格（円）
```

### 7.2. インデックス
- `posts`コレクション: `createdAt`（降順）でインデックス作成
- `posts`コレクション: `profit`（降順）でインデックス作成

---

## 8. Firestore 関数仕様

### 8.1. 概要
本システムで使用するFirebase Cloud Functionsの仕様を定義する。これらの関数は、データの整合性を保ち、クライアント側の処理負荷を軽減し、セキュリティを確保する役割を担う。

### 8.2. 共通仕様
- **ランタイム**: Node.js 20
- **リージョン**: asia-northeast1（東京）
- **CORS**: 許可（本番環境では特定ドメインのみに制限）
- **エラーハンドリング**: 適切なHTTPステータスコードとエラーメッセージを返却

### 8.3. 関数一覧

#### 8.3.1. createPost（投稿作成）
**目的**: ガチャ結果の投稿を作成し、お得度を自動計算する

**トリガー**: HTTPS呼び出し可能関数（Callable Function）

**入力パラメータ**:
```typescript
{
  drink1Name: string;  // ドリンク1の名前
  drink2Name: string;  // ドリンク2の名前
  photoUrl?: string;   // 写真のURL（オプション）
}
```

**処理フロー**:
1. 入力値のバリデーション
   - `drink1Name`と`drink2Name`が空でないことを確認
   - 文字列長が適切な範囲内であることを確認（最大50文字）
2. `drinkMaster`コレクションから両ドリンクの価格を取得
   - ドリンクが見つからない場合はエラーを返す
3. お得度を計算: `profit = (drink1Price + drink2Price) - GACHA_PRICE`
   - `GACHA_PRICE`は定数として定義（最安ドリンクの2倍の価格）
4. `posts`コレクションに新規ドキュメントを作成
   - `createdAt`はサーバータイムスタンプを使用
5. 作成した投稿のIDと計算されたprofitを返却

**戻り値**:
```typescript
{
  postId: string;
  profit: number;
}
```

**エラーケース**:
- `INVALID_ARGUMENT`: 必須パラメータが不足、または不正な値
- `NOT_FOUND`: 指定されたドリンクがマスターに存在しない
- `INTERNAL`: サーバー内部エラー

#### 8.3.2. getPosts（投稿一覧取得）
**目的**: 投稿のタイムラインを取得する

**トリガー**: HTTPS呼び出し可能関数（Callable Function）

**入力パラメータ**:
```typescript
{
  limit?: number;      // 取得件数（デフォルト: 50、最大: 100）
  startAfter?: string; // ページネーション用の開始位置（投稿ID）
}
```

**処理フロー**:
1. `limit`パラメータのバリデーション（1～100の範囲内）
2. `posts`コレクションから`createdAt`降順でクエリ
3. `startAfter`が指定されている場合、そのドキュメント以降を取得
4. 投稿データの配列を返却

**戻り値**:
```typescript
{
  posts: Array<{
    id: string;
    drink1Name: string;
    drink2Name: string;
    photoUrl: string | null;
    profit: number;
    createdAt: Timestamp;
  }>;
  hasMore: boolean;  // さらに投稿があるかどうか
}
```

**エラーケース**:
- `INVALID_ARGUMENT`: limitが範囲外
- `INTERNAL`: サーバー内部エラー

#### 8.3.3. getStatistics（統計情報取得）
**目的**: サイト全体の統計情報を取得する

**トリガー**: HTTPS呼び出し可能関数（Callable Function）

**入力パラメータ**: なし

**処理フロー**:
1. `posts`コレクションから全投稿を取得（キャッシュ利用を推奨）
2. ドリンク別排出回数を集計
3. お得度ランキングを作成（上位10件）
4. 累計お得額を計算
5. 統計データを返却

**戻り値**:
```typescript
{
  drinkRanking: Array<{
    name: string;
    count: number;
  }>;
  profitRanking: Array<{
    drink1Name: string;
    drink2Name: string;
    profit: number;
    createdAt: Timestamp;
  }>;
  totalProfit: number;
}
```

**エラーケース**:
- `INTERNAL`: サーバー内部エラー

**最適化**:
- 統計情報は頻繁に変更されないため、Cloud Firestoreのトリガー関数を使用して事前計算した結果を別のコレクションに保存することを推奨
- 投稿が追加されるたびに統計を再計算し、キャッシュを更新

#### 8.3.4. getDrinkMaster（ドリンクマスター取得）
**目的**: 利用可能なドリンクの一覧を取得する

**トリガー**: HTTPS呼び出し可能関数（Callable Function）

**入力パラメータ**: なし

**処理フロー**:
1. `drinkMaster`コレクションから全ドリンク情報を取得
2. 名前順でソートして返却

**戻り値**:
```typescript
{
  drinks: Array<{
    id: string;
    name: string;
    price: number;
  }>;
}
```

**エラーケース**:
- `INTERNAL`: サーバー内部エラー

#### 8.3.5. updateStatistics（統計更新トリガー）
**目的**: 投稿が追加された際に統計情報を自動更新する

**トリガー**: Firestore トリガー（onCreate）
- パス: `posts/{postId}`

**処理フロー**:
1. 新規投稿データを取得
2. `statistics`コレクションの統計ドキュメントを更新
   - ドリンク別カウントを増加
   - 累計お得額を加算
3. お得度ランキングを更新（必要に応じて）

**戻り値**: なし（バックグラウンド処理）

### 8.4. セキュリティルール

#### Firestore Security Rules
```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // postsコレクション: 読み取りは全員可、書き込みは関数経由のみ
    match /posts/{postId} {
      allow read: if true;
      allow write: if false;  // Cloud Functions経由でのみ作成
    }
    
    // drinkMasterコレクション: 読み取りは全員可、書き込みは管理者のみ
    match /drinkMaster/{drinkId} {
      allow read: if true;
      allow write: if false;  // 管理コンソールからのみ更新
    }
    
    // statisticsコレクション: 読み取りは全員可、書き込みは関数のみ
    match /statistics/{docId} {
      allow read: if true;
      allow write: if false;  // Cloud Functions経由でのみ更新
    }
  }
}
```

### 8.5. 環境変数
- `GACHA_PRICE`: ガチャの価格（円）
- `FIREBASE_PROJECT_ID`: FirebaseプロジェクトID
- `CORS_ORIGIN`: 許可するオリジン（本番環境用）

### 8.6. デプロイ手順
```bash
# Firebase CLIのインストール（初回のみ）
npm install -g firebase-tools

# Firebaseへログイン
firebase login

# functionsディレクトリで依存関係をインストール
cd functions
npm install

# 関数をデプロイ
firebase deploy --only functions
```

### 8.7. テスト方針
- 各関数に対してユニットテストを実装
- Firebase Emulator Suiteを使用したローカルテスト
- 統合テストでエンドツーエンドの動作を確認